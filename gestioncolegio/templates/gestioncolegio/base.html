{% load static %}
<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Colegio Cristiano El Shadai{% endblock %}</title>

    <!-- Favicon con fallbacks -->
    <link rel="icon" type="image/x-icon" href="{% static 'web/images/favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'web/images/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'web/images/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'web/images/favicon-16x16.png' %}">

    <!-- Preconnect para CDNs -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Select2 solo para roles específicos -->
    {% if user.tipo_usuario.nombre == "Administrador" or user.tipo_usuario.nombre == "Rector" or user.is_superuser %}
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    {% endif %}

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- CSS del sistema -->
    <link rel="stylesheet" href="{% static 'gestioncolegio/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'gestioncolegio/css/navbar.css' %}">

    <!-- Meta adicional -->
    {% block extra_meta %}
    <meta name="description" content="Sistema de Gestión Académica Colegio Cristiano El Shadai">
    <meta name="keywords" content="colegio, gestión académica, educación, estudiantes, docentes">
    <meta name="author" content="Colegio Cristiano El Shadai">
    <!-- Open Graph -->
    <meta property="og:title" content="Colegio Cristiano El Shadai - Sistema de Gestión">
    <meta property="og:description" content="Sistema de Gestión Académica Integral">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    {% endblock %}

    <!-- CSS adicional por vista -->
    {% block extra_css %}{% endblock %}
    
    <!-- Analytics (opcional) -->
    {% block analytics %}
    <!-- Google Analytics -->
    {% if not debug %}
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GKP54L448G"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GKP54L448G', {
            'page_title': '{% block page_title %}{% endblock %}',
            'page_path': '{{ request.path }}'
        });
    </script>
    {% endif %}
    {% endblock %}
</head>

<body>
    <!-- Skip to main content para accesibilidad -->
    <a href="#main-content" class="skip-link visually-hidden-focusable">
        Saltar al contenido principal
    </a>

    <!-- Navbar -->
    {% include 'gestioncolegio/includes/navbar.html' %}

    <!-- Contenido principal -->
    <main id="main-content" class="container-fluid py-4 fade-in" style="padding-top: var(--header-height);">
        {% include 'gestioncolegio/includes/messages.html' %}
        
        <!-- Breadcrumb opcional -->
        {% block breadcrumb %}{% endblock %}
        
        <!-- Contenido principal -->
        <div class="container-xxl">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    {% block footer %}
        {% include 'gestioncolegio/includes/footer.html' %}
    {% endblock %}

    <!-- Botón flotante para acciones rápidas -->
    {% if user.is_authenticated %}
    <div class="floating-actions">
        <div class="btn-group-vertical" role="group" aria-label="Acciones rápidas">
            {% if perms.gestioncolegio.add_noticia %}
            <!--
                <button type="button" class="btn btn-primary btn-floating rounded-circle mb-2" 
                        data-bs-toggle="tooltip" data-bs-placement="left" title="Nueva Noticia">
                    <i class="bi bi-plus-lg"></i>
                </button>
            -->
            {% endif %}
            <button type="button" class="btn btn-info btn-floating rounded-circle mb-2"
                    onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
                    data-bs-toggle="tooltip" data-bs-placement="left" title="Ir arriba">
                <i class="bi bi-arrow-up"></i>
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Modales -->
    {% block modals %}{% endblock %}

    <!-- Modal de confirmación global -->
    <div class="modal fade" id="globalConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalConfirmModalLabel">Confirmar acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="globalConfirmMessage">¿Está seguro de realizar esta acción?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="globalConfirmButton">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    
    {% if user.tipo_usuario.nombre == "Administrador" or user.tipo_usuario.nombre == "Rector" or user.is_superuser %}
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    <!-- SweetAlert2 (opcional) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Scripts globales del sistema -->
    <script>
        // Configuración global
        window.AppConfig = {
            debug: {% if debug %}true{% else %}false{% endif %},
            user: {
                id: {{ user.id|default:"null" }},
                name: "{{ user.get_full_name|default:'Usuario' }}",
                role: "{{ user.tipo_usuario.nombre|default:'Invitado' }}"
            },
            urls: {
                base: "{{ request.build_absolute_uri|slice:":-1" }}",
                csrf_token: "{{ csrf_token }}"
            }
        };

        // Inicializar tooltips y popovers
        document.addEventListener('DOMContentLoaded', function() {
            // Tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Popovers
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });

            // Confirmación global
            window.confirmAction = function(message, callback) {
                document.getElementById('globalConfirmMessage').textContent = message;
                var modal = new bootstrap.Modal(document.getElementById('globalConfirmModal'));
                modal.show();
                
                document.getElementById('globalConfirmButton').onclick = function() {
                    modal.hide();
                    if (typeof callback === 'function') {
                        callback();
                    }
                };
            };

            // Manejo de mensajes de Django
            var alertList = document.querySelectorAll('.alert');
            alertList.forEach(function (alert) {
                setTimeout(function() {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });

            // Prevenir doble envío de formularios
            document.querySelectorAll('form').forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    var submitBtn = form.querySelector('[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
                    }
                });
            });

            // Select2 para todos los select con clase 'select2'
            if (typeof $.fn.select2 !== 'undefined') {
                $('.select2').select2({
                    theme: 'bootstrap-5',
                    language: 'es',
                    width: '100%'
                });
            }

            // Scroll suave para anclas
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const href = this.getAttribute('href');
                    if (href !== '#') {
                        e.preventDefault();
                        const target = document.querySelector(href);
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }
                });
            });
        });

        // Tema claro/oscuro
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }

        // Cargar tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
    </script>

    <!-- Scripts adicionales por vista -->
    {% block extra_js %}{% endblock %}
    
    <!-- Scripts inline por vista -->
    {% block inline_js %}{% endblock %}
</body>
</html>