{% extends 'gestioncolegio/base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}Editar Logro{% else %}Crear Logro{% endif %} - Docentes
{% endblock %}

{% block content %}
<div class="container-fluid px-4">

    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4">
            <i class="fas fa-trophy me-2"></i>
            {% if object %}Editar Logro{% else %}Crear Logro{% endif %}
        </h1>
        <a href="{% url 'docentes:lista_logros' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold">
            <i class="fas fa-info-circle me-2"></i> Información del Logro
        </div>

        <div class="card-body">

            <form method="post" id="logro-form">
                {% csrf_token %}

                <!-- Fila superior -->
                <div class="row g-3">
                    <div class="col-md-4">
                        {{ form.grado|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.asignatura|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.periodo_academico|as_crispy_field }}
                    </div>
                </div>

                <div class="mt-3">
                    {{ form.tema|as_crispy_field }}
                </div>

                <h5 class="mt-4">Desempeños</h5>

                <div class="row g-3">

                    <!-- Superior -->
                    <div class="col-md-6">
                        <div class="card border-success h-100 shadow-sm">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-star me-2"></i> Nivel Superior
                            </div>
                            <div class="card-body">
                                {{ form.descripcion_superior|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Alto -->
                    <div class="col-md-6">
                        <div class="card border-primary h-100 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-thumbs-up me-2"></i> Nivel Alto
                            </div>
                            <div class="card-body">
                                {{ form.descripcion_alto|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Basico -->
                    <div class="col-md-6">
                        <div class="card border-warning h-100 shadow-sm">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-check me-2"></i> Nivel Básico
                            </div>
                            <div class="card-body">
                                {{ form.descripcion_basico|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Bajo -->
                    <div class="col-md-6">
                        <div class="card border-danger h-100 shadow-sm">
                            <div class="card-header bg-danger text-white">
                                <i class="fas fa-exclamation-circle me-2"></i> Nivel Bajo
                            </div>
                            <div class="card-body">
                                {{ form.descripcion_bajo|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-4">
                    <button type="submit" id="submit-btn" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        {% if object %}Actualizar{% else %}Crear{% endif %} Logro
                    </button>

                    <a href="{% url 'docentes:lista_logros' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const gradoSelect = document.getElementById("id_grado");
    const asignaturaSelect = document.getElementById("id_asignatura");
    const periodoSelect = document.getElementById("id_periodo_academico");
    const temaInput = document.getElementById("id_tema");
    const submitBtn = document.getElementById("submit-btn");

    const asignaturasUrl = "{% url 'docentes:ajax_obtener_asignaturas_por_grado' %}";

    // Deshabilitar asignatura si no hay grado
    if (!gradoSelect.value) {
        asignaturaSelect.disabled = true;
    }

    gradoSelect.addEventListener("change", async function () {
        let gradoId = gradoSelect.value;

        asignaturaSelect.innerHTML = `<option value="">Cargando...</option>`;
        asignaturaSelect.disabled = true;

        if (!gradoId) {
            asignaturaSelect.innerHTML = `<option value="">---------</option>`;
            return;
        }

        try {
            const response = await fetch(`${asignaturasUrl}?grado_id=${gradoId}`);
            const data = await response.json();

            asignaturaSelect.innerHTML = `<option value="">---------</option>`;

            data.asignaturas?.forEach(asig => {
                asignaturaSelect.innerHTML += `<option value="${asig.id}">${asig.nombre}</option>`;
            });

            asignaturaSelect.disabled = false;

            {% if object %}
                asignaturaSelect.value = "{{ object.asignatura.id }}";
            {% endif %}

        } catch (error) {
            asignaturaSelect.innerHTML = `<option value="">Error al cargar</option>`;
        }
    });

    // Validación del formulario
    document.getElementById("logro-form").addEventListener("submit", function (e) {

        if (!gradoSelect.value) {
            alert("Seleccione un grado.");
            e.preventDefault();
            return;
        }

        if (!asignaturaSelect.value) {
            alert("Seleccione una asignatura.");
            e.preventDefault();
            return;
        }

        if (!periodoSelect.value) {
            alert("Seleccione un periodo académico.");
            e.preventDefault();
            return;
        }

        if (!temaInput.value.trim()) {
            alert("Ingrese un tema.");
            e.preventDefault();
            return;
        }

        // Evitar doble envío
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Guardando...`;

    });

});
</script>
{% endblock %}
