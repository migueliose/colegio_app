<!-- administrador/asignaturas/asignatura_list.html -->
{% extends 'gestioncolegio/base.html' %}
{% load static estudiante_filters %}

{% block title %}Asignaturas - Sistema de Gestión{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-book me-2"></i>Asignaturas Académicas
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{% url 'administrador:asignatura_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Nueva Asignatura
            </a>
        </div>
    </div>

    <!-- Filtros avanzados -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>Filtrar Asignaturas
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="area" class="form-label">Área</label>
                            <select name="area" id="area" class="form-select">
                                <option value="">Todas las áreas</option>
                                {% for area in areas %}
                                <option value="{{ area.id }}" 
                                    {% if request.GET.area == area.id|stringformat:"i" %}selected{% endif %}>
                                    {{ area.nombre }} ({{ area.nivel_escolar.nombre }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="nivel" class="form-label">Nivel Escolar</label>
                            <select name="nivel" id="nivel" class="form-select">
                                <option value="">Todos los niveles</option>
                                {% for nivel in niveles_escolares %}
                                <option value="{{ nivel.id }}"
                                    {% if request.GET.nivel == nivel.id|stringformat:"i" %}selected{% endif %}>
                                    {{ nivel.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ request.GET.search }}" placeholder="Nombre de asignatura...">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i> Buscar
                            </button>
                            <a href="{% url 'administrador:asignatura_list' %}" class="btn btn-secondary">
                                <i class="fas fa-redo me-1"></i> Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-start-primary shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Total Asignaturas
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ asignaturas.count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-start-info shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                Preescolar
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ preescolar_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-school fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-start-success shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Primaria
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ primaria_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-university fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-start-warning shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Con Intensidad Horaria
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ con_ih_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de asignaturas -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Asignaturas
                        <span class="badge bg-primary ms-2">{{ asignaturas.paginator.count|default:asignaturas.count }}</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="printTable()">
                            <i class="fas fa-print me-1"></i> Imprimir
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if asignaturas %}
                    <div class="table-responsive" id="printableTable">
                        <table class="table table-hover" id="asignaturasTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">ID</th>
                                    <th width="25%">Nombre</th>
                                    <th width="20%">Área</th>
                                    <th width="15%">Nivel</th>
                                    <th width="10%">Int. Horaria</th>
                                    <th width="15%">Creado</th>
                                    <th width="10%" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asignatura in asignaturas %}
                                <tr>
                                    <td>{{ asignatura.id }}</td>
                                    <td>
                                        <strong>{{ asignatura.nombre }}</strong>
                                        {% if asignatura.logros.exists %}
                                        <small class="text-muted d-block mt-1">
                                            <i class="fas fa-trophy me-1 text-warning"></i>
                                            {{ asignatura.logros.count }} logro(s)
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">
                                            {{ asignatura.area.nombre }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge {% if asignatura.area.nivel_escolar.nombre == 'Preescolar' %}bg-info{% else %}bg-success{% endif %}">
                                            {{ asignatura.area.nivel_escolar.nombre }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if asignatura.ih %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock me-1"></i>{{ asignatura.ih }}h
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">No asignada</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ asignatura.created_at|date:"d/m/Y" }}
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'administrador:asignatura_update' asignatura.pk %}" 
                                               class="btn btn-outline-primary" 
                                               title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'administrador:asignatura_delete' asignatura.pk %}" 
                                               class="btn btn-outline-danger" 
                                               title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No se encontraron asignaturas</h5>
                                        <p class="text-muted">Intente con otros filtros o cree una nueva asignatura</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginación -->
                    {% if is_paginated %}
                    <nav aria-label="Paginación de asignaturas">
                        <ul class="pagination justify-content-center mt-4">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        {{ num }}
                                    </a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                        <p class="text-center text-muted mt-2">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </p>
                    </nav>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-book fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No hay asignaturas registradas</h4>
                        <p class="text-muted">Comience creando una nueva asignatura</p>
                        <a href="{% url 'administrador:asignatura_create' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-plus me-1"></i> Crear Primera Asignatura
                        </a>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Información del filtro activo -->
                {% if request.GET.area or request.GET.nivel or request.GET.search %}
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-filter me-1"></i>
                        <strong>Filtro activo:</strong>
                        {% if request.GET.area %}
                        Área: {{ areas|get_area_name:request.GET.area }},
                        {% endif %}
                        {% if request.GET.nivel %}
                        Nivel: {{ niveles_escolares|get_nivel_name:request.GET.nivel }},
                        {% endif %}
                        {% if request.GET.search %}
                        Búsqueda: "{{ request.GET.search }}"
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

.card {
    border-radius: 10px;
    margin-bottom: 1rem;
}

.border-start-primary { border-left-color: #0d6efd !important; }
.border-start-info { border-left-color: #0dcaf0 !important; }
.border-start-success { border-left-color: #198754 !important; }
.border-start-warning { border-left-color: #ffc107 !important; }

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

@media print {
    .btn, .card-header, .breadcrumb, .navbar, .pagination, .card-footer {
        display: none !important;
    }
    
    #printableTable {
        display: block !important;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        border: 1px solid #000;
        padding: 8px;
    }
}
</style>

<script>
// Exportar a Excel
function exportToExcel() {
    const table = document.getElementById('asignaturasTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    rows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td, th');
        cells.forEach(cell => {
            // Limpiar HTML y tomar solo texto
            const text = cell.innerText.replace(/\n/g, ' ').trim();
            rowData.push(`"${text}"`);
        });
        csv.push(rowData.join(','));
    });
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.href = url;
    link.download = `asignaturas_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

// Imprimir tabla
function printTable() {
    const printContent = document.getElementById('printableTable').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
        <html>
            <head>
                <title>Lista de Asignaturas - ${new Date().toLocaleDateString()}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th { background-color: #f2f2f2; border: 1px solid #ddd; padding: 8px; text-align: left; font-weight: bold; }
                    td { border: 1px solid #ddd; padding: 8px; }
                    h1 { color: #333; text-align: center; margin-bottom: 5px; }
                    .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333; }
                    .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                    @media print {
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Lista de Asignaturas</h1>
                    <p><strong>Colegio:</strong> Sistema de Gestión Escolar</p>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Total registros:</strong> {{ asignaturas.paginator.count|default:asignaturas.count }}</p>
                </div>
                ${printContent}
                <div class="footer">
                    <p>Documento generado el ${new Date().toLocaleString()}</p>
                    <p>Página 1 de 1</p>
                </div>
            </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
}

// Filtrar áreas por nivel seleccionado
document.getElementById('nivel').addEventListener('change', function() {
    const nivelId = this.value;
    const areaSelect = document.getElementById('area');
    
    if (nivelId) {
        // Obtener todas las opciones
        const allOptions = Array.from(areaSelect.querySelectorAll('option'));
        
        // Mostrar todas las opciones primero
        allOptions.forEach(option => {
            option.style.display = '';
        });
        
        // Filtrar por nivel
        allOptions.forEach(option => {
            if (option.value !== '') {
                const optionText = option.textContent;
                const nivelNombre = document.getElementById('nivel').selectedOptions[0].text;
                if (!optionText.includes(`(${nivelNombre})`) && nivelNombre !== 'Todos los niveles') {
                    option.style.display = 'none';
                }
            }
        });
        
        // Si no hay opciones visibles, mostrar mensaje
        const visibleOptions = allOptions.filter(opt => opt.style.display !== 'none');
        if (visibleOptions.length === 1) { // Solo la opción "Todas las áreas"
            const newOption = document.createElement('option');
            newOption.value = '';
            newOption.textContent = 'No hay áreas para este nivel';
            newOption.disabled = true;
            newOption.selected = true;
            areaSelect.innerHTML = '';
            areaSelect.appendChild(newOption);
        }
    } else {
        // Mostrar todas las opciones
        Array.from(areaSelect.querySelectorAll('option')).forEach(option => {
            option.style.display = '';
        });
        areaSelect.value = '';
    }
});
</script>
{% endblock %}