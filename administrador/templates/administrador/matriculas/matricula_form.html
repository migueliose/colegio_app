<!-- administrador/matriculas/matricula_form.html -->
{% extends 'gestioncolegio/base2.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-2">{{ title }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'administrador:matricula_list' %}">Matrículas</a></li>
                    <li class="breadcrumb-item active">{{ title }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <a href="{% url 'administrador:matricula_list' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Información de la Matrícula</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="matricula-form">
                        {% csrf_token %}
                        
                        <!-- Información del estudiante -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">Información del Estudiante</h6>
                            
                            {% if form.estudiante_info %}
                            <!-- Si viene de estudiante_detail -->
                            <div class="alert alert-info mb-3">
                                <div class="d-flex">
                                    <i class="fas fa-info-circle me-2 mt-1"></i>
                                    <div>
                                        <p class="mb-0"><strong>Estudiante seleccionado:</strong></p>
                                        {{ form.estudiante_info }}
                                        {{ form.estudiante_hidden }}
                                        {{ form.tipo_estudiante }}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <!-- Si se crea desde cero -->
                            <div class="mb-3">
                                <label class="form-label">Tipo de estudiante</label>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="card border">
                                            <div class="card-body text-center">
                                                <div class="form-check mb-0">
                                                    <input class="form-check-input" type="radio" name="tipo_estudiante" 
                                                           id="id_tipo_estudiante_0" value="existente" 
                                                           {% if form.tipo_estudiante.value == 'existente' or not form.tipo_estudiante.value %}checked{% endif %}>
                                                    <label class="form-check-label d-block" for="id_tipo_estudiante_0">
                                                        <i class="fas fa-search fa-2x mb-2 text-primary"></i>
                                                        <h6 class="mb-1">Estudiante existente</h6>
                                                        <p class="text-muted small mb-0">Seleccionar de la lista</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border">
                                            <div class="card-body text-center">
                                                <div class="form-check mb-0">
                                                    <input class="form-check-input" type="radio" name="tipo_estudiante" 
                                                           id="id_tipo_estudiante_1" value="nuevo"
                                                           {% if form.tipo_estudiante.value == 'nuevo' %}checked{% endif %}>
                                                    <label class="form-check-label d-block" for="id_tipo_estudiante_1">
                                                        <i class="fas fa-user-plus fa-2x mb-2 text-success"></i>
                                                        <h6 class="mb-1">Crear nuevo estudiante</h6>
                                                        <p class="text-muted small mb-0">Registrar nuevo</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel para estudiante existente -->
                            <div id="panel-estudiante-existente" class="panel-estudiante">
                                <div class="mb-3">
                                    <label for="id_estudiante_existente" class="form-label">Buscar estudiante</label>
                                    <select name="estudiante_existente" id="id_estudiante_existente" class="form-control">
                                        <option value="">Seleccionar estudiante...</option>
                                        {% for estudiante in form.estudiante_existente.field.queryset %}
                                        <option value="{{ estudiante.id }}" 
                                                {% if form.estudiante_existente.value == estudiante.id|stringformat:"s" %}selected{% endif %}>
                                            {{ estudiante.usuario.get_full_name }} - {{ estudiante.usuario.numero_documento }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.estudiante_existente.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.estudiante_existente.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Busque por nombre, apellido o documento
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel para nuevo estudiante -->
                            <div id="panel-nuevo-estudiante" class="panel-estudiante d-none">
                                <div class="alert alert-light border mb-3">
                                    <p class="mb-0"><strong>Datos del nuevo estudiante</strong></p>
                                </div>
                                
                                <!-- Datos básicos -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <label for="id_nuevo_tipo_documento" class="form-label">Tipo de Documento *</label>
                                        <select name="nuevo_tipo_documento" id="id_nuevo_tipo_documento" class="form-control">
                                            <option value="">Seleccionar...</option>
                                            {% for tipo in form.nuevo_tipo_documento.field.queryset %}
                                            <option value="{{ tipo.id }}" 
                                                    {% if form.nuevo_tipo_documento.value == tipo.id|stringformat:"s" %}selected{% endif %}>
                                                {{ tipo.nombre }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.nuevo_tipo_documento.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_tipo_documento.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="id_nuevo_numero_documento" class="form-label">Número de Documento *</label>
                                        <input type="text" name="nuevo_numero_documento" id="id_nuevo_numero_documento" 
                                               class="form-control" value="{{ form.nuevo_numero_documento.value|default:'' }}"
                                               placeholder="Ej: 12345678">
                                        {% if form.nuevo_numero_documento.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_numero_documento.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Nombres y apellidos -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <label for="id_nuevo_nombres" class="form-label">Nombres *</label>
                                        <input type="text" name="nuevo_nombres" id="id_nuevo_nombres" 
                                               class="form-control" value="{{ form.nuevo_nombres.value|default:'' }}"
                                               placeholder="Nombres completos">
                                        {% if form.nuevo_nombres.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_nombres.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="id_nuevo_apellidos" class="form-label">Apellidos *</label>
                                        <input type="text" name="nuevo_apellidos" id="id_nuevo_apellidos" 
                                               class="form-control" value="{{ form.nuevo_apellidos.value|default:'' }}"
                                               placeholder="Apellidos completos">
                                        {% if form.nuevo_apellidos.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_apellidos.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Información de contacto -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <label for="id_nuevo_email" class="form-label">Correo electrónico</label>
                                        <input type="email" name="nuevo_email" id="id_nuevo_email" 
                                               class="form-control" value="{{ form.nuevo_email.value|default:'' }}"
                                               placeholder="ejemplo@email.com">
                                        {% if form.nuevo_email.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_email.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="id_nuevo_telefono" class="form-label">Teléfono</label>
                                        <input type="tel" name="nuevo_telefono" id="id_nuevo_telefono" 
                                               class="form-control" value="{{ form.nuevo_telefono.value|default:'' }}"
                                               placeholder="Ej: 3001234567">
                                        {% if form.nuevo_telefono.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_telefono.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Información personal -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <label for="id_nuevo_sexo" class="form-label">Sexo</label>
                                        <select name="nuevo_sexo" id="id_nuevo_sexo" class="form-control">
                                            <option value="">Seleccionar...</option>
                                            {% for value, label in form.nuevo_sexo.field.choices %}
                                            {% if value %}
                                            <option value="{{ value }}" 
                                                    {% if form.nuevo_sexo.value == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                        {% if form.nuevo_sexo.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_sexo.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="id_nuevo_fecha_nacimiento" class="form-label">Fecha de nacimiento</label>
                                        <input type="date" name="nuevo_fecha_nacimiento" id="id_nuevo_fecha_nacimiento" 
                                               class="form-control" value="{{ form.nuevo_fecha_nacimiento.value|default:'' }}">
                                        {% if form.nuevo_fecha_nacimiento.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.nuevo_fecha_nacimiento.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Dirección -->
                                <div class="mb-3">
                                    <label for="id_nuevo_direccion" class="form-label">Dirección</label>
                                    <input type="text" name="nuevo_direccion" id="id_nuevo_direccion" 
                                           class="form-control" value="{{ form.nuevo_direccion.value|default:'' }}"
                                           placeholder="Dirección completa">
                                    {% if form.nuevo_direccion.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.nuevo_direccion.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="alert alert-info mt-3">
                                    <div class="d-flex">
                                        <i class="fas fa-info-circle me-2 mt-1"></i>
                                        <div>
                                            <p class="mb-1"><small>Los campos marcados con * son obligatorios.</small></p>
                                            <p class="mb-0"><small>La contraseña por defecto será el número de documento.</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Información de la matrícula -->
                        <div class="border-top pt-3">
                            <h6 class="border-bottom pb-2 mb-3">Información de la Matrícula</h6>
                            
                            <div class="row g-2">
                                <!-- Año Lectivo -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_año_lectivo" class="form-label">Año Lectivo</label>
                                    {{ form.año_lectivo }}
                                    {% if form.año_lectivo.help_text %}
                                    <div class="form-text">
                                        {{ form.año_lectivo.help_text }}
                                    </div>
                                    {% endif %}
                                    {% if form.año_lectivo.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.año_lectivo.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Sede -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_sede" class="form-label">Sede</label>
                                    {{ form.sede }}
                                    {% if form.sede.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.sede.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Grado -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_grado_año_lectivo" class="form-label">Grado</label>
                                    {{ form.grado_año_lectivo }}
                                    {% if form.grado_año_lectivo.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.grado_año_lectivo.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Estado -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_estado" class="form-label">Estado de Matrícula</label>
                                    {{ form.estado }}
                                    {% if form.estado.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.estado.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Observaciones -->
                                <div class="col-12 mb-3">
                                    <label for="id_observaciones" class="form-label">Observaciones</label>
                                    {{ form.observaciones }}
                                    {% if form.observaciones.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.observaciones.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Observaciones adicionales sobre la matrícula
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="border-top pt-3 mt-3">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'administrador:matricula_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> {{ submit_text }}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panel de información lateral -->
        <div class="col-lg-4">
            {% if estudiante_info %}
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i> Estudiante Seleccionado</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if estudiante_info.usuario.foto %}
                        <img src="{{ estudiante_info.usuario.foto.url }}" 
                             alt="{{ estudiante_info.usuario.get_full_name }}" 
                             class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto" 
                             style="width: 80px; height: 80px;">
                            <i class="fas fa-user text-muted fa-2x"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <h6 class="text-center mb-3">{{ estudiante_info.usuario.get_full_name }}</h6>
                    
                    <div class="small">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Documento:</span>
                            <span>{{ estudiante_info.usuario.numero_documento }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Edad:</span>
                            <span>{{ estudiante_info.usuario.edad|default:"-" }} años</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Género:</span>
                            <span>{{ estudiante_info.usuario.get_sexo_display|default:"-" }}</span>
                        </div>
                    </div>
                    
                    {% if tiene_matricula_actual %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>¡Atención!</strong> Este estudiante ya tiene una matrícula 
                        en el año {{ año_actual.anho }}.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if matriculas_anteriores %}
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i> Historial de Matrículas</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for matricula in matriculas_anteriores %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0">{{ matricula.año_lectivo.anho }}</h6>
                                <span class="badge {% if matricula.estado == 'ACT' %}bg-success{% elif matricula.estado == 'RET' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ matricula.get_estado_display }}
                                </span>
                            </div>
                            <p class="mb-1 small">
                                {{ matricula.grado_año_lectivo.grado.nombre }}
                            </p>
                            <small class="text-muted">
                                <i class="fas fa-school me-1"></i>{{ matricula.sede.nombre }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Alternar entre paneles de estudiante
    function togglePanelsEstudiante() {
        var tipoEstudiante = $('input[name="tipo_estudiante"]:checked').val();
        
        if (tipoEstudiante === 'existente') {
            $('#panel-estudiante-existente').removeClass('d-none');
            $('#panel-nuevo-estudiante').addClass('d-none');
            // Quitar required de campos de nuevo estudiante
            $('#id_nuevo_numero_documento, #id_nuevo_nombres, #id_nuevo_apellidos, #id_nuevo_tipo_documento')
                .removeAttr('required');
        } else if (tipoEstudiante === 'nuevo') {
            $('#panel-estudiante-existente').addClass('d-none');
            $('#panel-nuevo-estudiante').removeClass('d-none');
            // Agregar required a campos de nuevo estudiante
            $('#id_nuevo_numero_documento, #id_nuevo_nombres, #id_nuevo_apellidos, #id_nuevo_tipo_documento')
                .attr('required', 'required');
        }
    }
    
    // Inicializar paneles
    togglePanelsEstudiante();
    
    // Escuchar cambios en el tipo de estudiante
    $('input[name="tipo_estudiante"]').change(function() {
        togglePanelsEstudiante();
    });
    
    // Click en tarjeta también selecciona el radio
    
    // Verificar documento cuando se escribe
    $('#id_nuevo_numero_documento').on('blur', function() {
        var numeroDocumento = $(this).val();
        if (numeroDocumento) {
            $.ajax({
                url: '{% url "administrador:verificar_usuario" %}',
                data: {
                    'numero_documento': numeroDocumento,
                    'tipo_usuario': 'Estudiante'
                },
                success: function(data) {
                    if (data.existe) {
                        if (data.usuario.ya_es_tipo) {
                            // Ya es estudiante
                            $('#id_nuevo_numero_documento').addClass('is-invalid');
                            $('#id_nuevo_numero_documento').after(
                                '<div class="invalid-feedback d-block">' +
                                'Este número de documento ya pertenece a un estudiante.' +
                                '</div>'
                            );
                        } else {
                            // Es usuario pero no estudiante, sugerir usar existente
                            $('#id_nuevo_numero_documento').addClass('is-warning');
                            $('#id_nuevo_numero_documento').after(
                                '<div class="alert alert-warning mt-2">' +
                                '<i class="fas fa-exclamation-triangle me-2"></i>' +
                                'Este documento ya existe en el sistema. ' +
                                'Recomendamos usar la opción "Estudiante existente".' +
                                '</div>'
                            );
                        }
                    } else {
                        $('#id_nuevo_numero_documento').removeClass('is-invalid is-warning');
                        $('.invalid-feedback, .alert').remove();
                    }
                }
            });
        }
    });
    
    // Actualizar grados y sedes cuando cambie el año lectivo
    $('#id_año_lectivo').change(function() {
        var añoLectivoId = $(this).val();
        
        if (añoLectivoId) {
            // Mostrar loading
            $('#id_grado_año_lectivo').prop('disabled', true);
            $('#id_sede').prop('disabled', true);
            
            // Actualizar grados
            $.ajax({
                url: '{% url "administrador:matricula_ajax" %}',
                data: {
                    'tipo': 'grados_por_año',
                    'año_lectivo_id': añoLectivoId
                },
                dataType: 'json',
                success: function(data) {
                    var $gradoSelect = $('#id_grado_año_lectivo');
                    $gradoSelect.empty();
                    
                    if (data.grados && data.grados.length > 0) {
                        $gradoSelect.append($('<option>', {
                            value: '',
                            text: 'Seleccione un grado...'
                        }));
                        
                        $.each(data.grados, function(index, grado) {
                            $gradoSelect.append($('<option>', {
                                value: grado.id,
                                text: grado.nombre
                            }));
                        });
                        $gradoSelect.prop('disabled', false);
                    } else {
                        $gradoSelect.append($('<option>', {
                            value: '',
                            text: 'No hay grados disponibles para este año'
                        }));
                    }
                },
                complete: function() {
                    $('#id_grado_año_lectivo').prop('disabled', false);
                }
            });
            
            // Actualizar sedes
            $.ajax({
                url: '{% url "administrador:matricula_ajax" %}',
                data: {
                    'tipo': 'sedes_por_año',
                    'año_lectivo_id': añoLectivoId
                },
                dataType: 'json',
                success: function(data) {
                    var $sedeSelect = $('#id_sede');
                    $sedeSelect.empty();
                    
                    if (data.sedes && data.sedes.length > 0) {
                        $sedeSelect.append($('<option>', {
                            value: '',
                            text: 'Seleccione una sede...'
                        }));
                        
                        $.each(data.sedes, function(index, sede) {
                            $sedeSelect.append($('<option>', {
                                value: sede.id,
                                text: sede.nombre
                            }));
                        });
                        $sedeSelect.prop('disabled', false);
                    } else {
                        $sedeSelect.append($('<option>', {
                            value: '',
                            text: 'No hay sedes disponibles para este año'
                        }));
                    }
                },
                complete: function() {
                    $('#id_sede').prop('disabled', false);
                }
            });
        }
    });
    
    // Si hay errores en los campos del formulario, mostrar el panel correspondiente
    {% if form.errors %}
        {% if form.nuevo_numero_documento.errors or form.nuevo_nombres.errors or form.nuevo_apellidos.errors %}
        // Si hay errores en campos de nuevo estudiante, mostrar ese panel
        $('input[name="tipo_estudiante"][value="nuevo"]').prop('checked', true).trigger('change');
        {% endif %}
        
        {% if form.estudiante_existente.errors %}
        // Si hay errores en campo de estudiante existente
        $('input[name="tipo_estudiante"][value="existente"]').prop('checked', true).trigger('change');
        {% endif %}
    {% endif %}
});
</script>

<style>
/* Estilos simples */
.panel-estudiante {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.card {
    cursor: pointer;
    transition: border-color 0.2s;
}

.card:hover {
    border-color: #0d6efd;
}

.card .form-check-input {
    margin-top: 0;
}

.card .fa-2x {
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
}

.alert {
    border-radius: 0.375rem;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}