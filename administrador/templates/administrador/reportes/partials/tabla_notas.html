<!-- templates/administrador/reportes/partials/tabla_notas.html -->
{% if tipo_reporte == 'individual' %}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    {% if estudiante.foto %}
                    <img src="{{ estudiante.foto.url }}" class="rounded-circle mb-3" width="100" height="100" alt="{{ estudiante.usuario.get_full_name }}">
                    {% else %}
                    <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px;">
                        <i class="bi bi-person text-white" style="font-size: 3rem;"></i>
                    </div>
                    {% endif %}
                    <h4>{{ estudiante.usuario.get_full_name }}</h4>
                    <p class="text-muted mb-2">{{ estudiante.usuario.numero_documento }}</p>
                    {% if estudiante.grado_actual %}
                    <span class="badge bg-primary">{{ estudiante.grado_actual.grado.nombre }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Promedio General</h6>
                            <div class="average-circle mx-auto mb-3 {% if promedio_general >= 4.0 %}bg-success text-white{% elif promedio_general >= 3.0 %}bg-warning text-dark{% else %}bg-danger text-white{% endif %}">
                                {{ promedio_general|floatformat:1 }}
                            </div>
                            <p class="mb-0">
                                {% if promedio_general >= 4.0 %}
                                <span class="text-success">Excelente</span>
                                {% elif promedio_general >= 3.0 %}
                                <span class="text-warning">Aceptable</span>
                                {% else %}
                                <span class="text-danger">Requiere atención</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="text-muted mb-3">Resumen por Asignatura</h6>
                            {% for asignatura, promedio in promedios.items %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ asignatura|truncatechars:20 }}</span>
                                <span class="badge {% if promedio >= 4.0 %}grade-excellent{% elif promedio >= 3.0 %}grade-good{% else %}grade-poor{% endif %}">
                                    {{ promedio|floatformat:1 }}
                                </span>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center">No hay notas registradas</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Detalle de Notas</h5>
            <form method="post" action="{% url 'administrador:exportar_reporte' %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="tipo_reporte" value="notas">
                <input type="hidden" name="formato" value="pdf">
                
                <!-- Campos específicos para boletín individual -->
                <input type="hidden" name="tipo_reporte_original" value="individual">
                
                {% if estudiante %}
                <input type="hidden" name="estudiante_id" value="{{ estudiante.id }}">
                <input type="hidden" name="periodo_id" value="{{ filtros.periodo_id }}">
                {% endif %}
                
                <button type="submit" class="btn btn-sm btn-danger">
                    <i class="bi bi-file-pdf me-1"></i>PDF
                </button>
            </form>
        </div>
        <div class="card-body">
        <!-- Tabla para reporte individual -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Asignatura</th>
                        <th>Periodo</th>
                        <th>Calificación</th>
                        <th>Desempeño</th>
                        <th>Observaciones</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nota in notas_individuales %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="subject-icon bg-light me-3">
                                    <i class="bi bi-book text-primary"></i>
                                </div>
                                <div>
                                    <strong>{{ nota.asignatura_grado_año_lectivo.asignatura.nombre }}</strong>
                                    <div class="text-muted small">{{ nota.asignatura_grado_año_lectivo.asignatura.area.nombre|default:"Sin área" }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {{ nota.periodo_academico.periodo.nombre }}
                            <div class="text-muted small">{{ nota.periodo_academico.año_lectivo.anho }}</div>
                        </td>
                        <td>
                            <span class="badge {% if nota.calificacion >= 4.0 %}grade-excellent{% elif nota.calificacion >= 3.0 %}grade-good{% elif nota.calificacion >= 2.0 %}grade-average{% else %}grade-poor{% endif %} grade-badge">
                                {{ nota.calificacion }}
                            </span>
                        </td>
                        <td>
                            {% if nota.calificacion >= 4.0 %}
                            <span class="text-success">Superior</span>
                            {% elif nota.calificacion >= 3.0 %}
                            <span class="text-warning">Básico</span>
                            {% elif nota.calificacion >= 2.0 %}
                            <span class="text-warning">Bajo</span>
                            {% else %}
                            <span class="text-danger">Insuficiente</span>
                            {% endif %}
                        </td>
                        <td>{{ nota.observaciones|truncatechars:30|default:"Sin observaciones" }}</td>
                        <td>{{ nota.created_at|date:"d/m/Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-journal-x display-4 text-muted"></i>
                            <h5 class="mt-3">No hay notas registradas</h5>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>    
{% else %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Notas</h6>
                    <h2 class="mb-0">{{ estadisticas.total_notas }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Promedio General</h6>
                    <h2 class="mb-0">{{ estadisticas.promedio_general|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Nota Máxima</h6>
                    <h2 class="mb-0">{{ estadisticas.max_nota|floatformat:1 }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Nota Mínima</h6>
                    <h2 class="mb-0">{{ estadisticas.min_nota|floatformat:1 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de notas grupales -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Resultados: {{ datos_grupales|length }} estudiantes</h5>
            <div class="d-flex gap-2">
                <form method="post" action="{% url 'administrador:exportar_reporte' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_reporte" value="notas">
                    <input type="hidden" name="formato" value="excel">
                    
                    <!-- Campos comunes para ambos tipos de reporte -->
                    <input type="hidden" name="periodo" value="{{ filtros.periodo_id }}">
                    <input type="hidden" name="grado" value="{{ filtros.grado_id }}">
                    <input type="hidden" name="asignatura" value="{{ filtros.asignatura_id }}">
                    <input type="hidden" name="sede" value="{{ filtros.sede_id }}">
                    
                    <!-- Campo específico para tipo de reporte (individual o grupal) -->
                    <input type="hidden" name="tipo_reporte_original" value="{{ tipo_reporte }}">
                    
                    <!-- Solo para reporte individual -->
                    {% if tipo_reporte == 'individual' and estudiante %}
                    <input type="hidden" name="estudiante_id" value="{{ estudiante.id }}">
                    <input type="hidden" name="periodo_id" value="{{ filtros.periodo_id }}">
                    {% endif %}
                    
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="bi bi-file-excel me-1"></i>Excel
                    </button>
                </form>
                <form method="post" action="{% url 'administrador:exportar_reporte' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_reporte" value="notas">
                    <input type="hidden" name="formato" value="csv">
                    <button type="submit" class="btn btn-sm btn-secondary">
                        <i class="bi bi-file-text me-1"></i>CSV
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body">
            <!-- Tabla para reporte grupal -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Notas</th>
                            <th>Promedio</th>
                            <th>Desempeño</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dato in datos_grupales %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if dato.estudiante.foto %}
                                    <img src="{{ dato.estudiante.foto.url }}" class="rounded-circle me-2" width="40" height="40" alt="{{ dato.estudiante.usuario.get_full_name }}">
                                    {% else %}
                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                        <i class="bi bi-person text-white"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ dato.estudiante.usuario.get_full_name }}</strong>
                                        <div class="text-muted small">{{ dato.estudiante.usuario.numero_documento }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for nota in dato.notas|slice:":5" %}
                                    <span class="badge {% if nota.calificacion >= 4.0 %}grade-excellent{% elif nota.calificacion >= 3.0 %}grade-good{% elif nota.calificacion >= 2.0 %}grade-average{% else %}grade-poor{% endif %}">
                                        {{ nota.calificacion }}
                                    </span>
                                    {% endfor %}
                                    {% if dato.cantidad_notas > 5 %}
                                    <span class="badge bg-secondary">+{{ dato.cantidad_notas|add:"-5" }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="average-circle mx-auto {% if dato.promedio >= 4.0 %}bg-success text-white{% elif dato.promedio >= 3.0 %}bg-warning text-dark{% else %}bg-danger text-white{% endif %}" style="width: 50px; height: 50px; font-size: 1rem;">
                                    {{ dato.promedio|floatformat:1 }}
                                </div>
                            </td>
                            <td>
                                {% if dato.promedio >= 4.0 %}
                                <span class="text-success">Superior</span>
                                {% elif dato.promedio >= 3.0 %}
                                <span class="text-warning">Básico</span>
                                {% elif dato.promedio >= 2.0 %}
                                <span class="text-warning">Bajo</span>
                                {% else %}
                                <span class="text-danger">Insuficiente</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'administrador:reporte_notas' %}?tipo=individual&estudiante={{ dato.estudiante.id }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <i class="bi bi-journal-x display-4 text-muted"></i>
                                <h5 class="mt-3">No hay notas registradas</h5>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endif %}

<style>
.grade-badge {
    font-size: 0.9rem;
    padding: 0.25rem 0.5rem;
}

.grade-excellent { background-color: #198754; color: white; }
.grade-good { background-color: #20c997; color: white; }
.grade-average { background-color: #ffc107; color: black; }
.grade-poor { background-color: #dc3545; color: white; }

.subject-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.average-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}
</style>