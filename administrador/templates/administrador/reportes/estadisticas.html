{% extends 'gestioncolegio/base2.html' %}
{% load static %}

{% block title %}Estadísticas Generales - Colegio App{% endblock %}

{% block extra_css %}
<style>
    .stats-highlight {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1.2;
    }
    
    .stats-card {
        border-radius: 15px;
        transition: all 0.3s;
        overflow: hidden;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }
    
    .trend-up { color: #198754; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    .chart-card {
        height: 350px;
    }
    
    .distribution-item {
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        background: #f8f9fa;
        transition: background 0.2s;
    }
    
    .distribution-item:hover {
        background: #e9ecef;
    }
    
    .progress-large {
        height: 12px;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">Estadísticas Generales</h1>
            <p class="text-muted">Dashboard ejecutivo con indicadores clave del colegio</p>
        </div>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="bi bi-printer me-2"></i>Imprimir Reporte
            </button>
            <a href="{% url 'administrador:dashboard_reportes' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Volver
            </a>
        </div>
    </div>

    <!-- Año lectivo actual -->
    {% if año_actual %}
    <div class="alert alert-primary mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1">
                    <i class="bi bi-calendar-check me-2"></i>
                    Año Lectivo Activo: {{ año_actual.anho }}
                </h5>
                <p class="mb-0">
                    Sede: {{ año_actual.sede.nombre }} | 
                    Fecha inicio: {{ año_actual.fecha_inicio|date:"d/m/Y"|default:"No definida" }} | 
                    Fecha fin: {{ año_actual.fecha_fin|date:"d/m/Y"|default:"No definida" }}
                </p>
            </div>
            <span class="badge bg-success fs-6">Activo</span>
        </div>
    </div>
    {% endif %}

    <!-- Indicadores principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-0 bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50">Total Estudiantes</h6>
                            <h2 class="stats-highlight">{{ estadisticas.total_estudiantes }}</h2>
                            <small class="opacity-75">Registrados en el sistema</small>
                        </div>
                        <div class="stats-icon bg-white-20">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-white text-primary">
                            {{ estadisticas.estudiantes_activos }} activos este año
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-0 bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50">Rendimiento Académico</h6>
                            <h2 class="stats-highlight">{{ estadisticas.promedio_general }}</h2>
                            <small class="opacity-75">Promedio general</small>
                        </div>
                        <div class="stats-icon bg-white-20">
                            <i class="bi bi-graph-up"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-white text-success">
                            {{ estadisticas.tasa_aprobacion }}% tasa de aprobación
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-0 bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50">Asistencia Promedio</h6>
                            <h2 class="stats-highlight">{{ estadisticas.asistencia_promedio }}%</h2>
                            <small class="opacity-75">Este año lectivo</small>
                        </div>
                        <div class="stats-icon bg-white-20">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress bg-white-20" style="height: 6px;">
                            <div class="progress-bar bg-white" style="width: {{ estadisticas.asistencia_promedio }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-0 bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50">Comportamiento</h6>
                            <h2 class="stats-highlight">{{ estadisticas.ratio_comportamiento }}%</h2>
                            <small class="opacity-75">Positivo vs Negativo</small>
                        </div>
                        <div class="stats-icon bg-white-20">
                            <i class="bi bi-emoji-smile"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-white text-warning me-1">
                            {{ estadisticas.comportamientos_positivos }} positivos
                        </span>
                        <span class="badge bg-white text-warning">
                            {{ estadisticas.comportamientos_negativos }} negativos
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda fila de indicadores -->
    <div class="row mb-4">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>Infraestructura</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-3 border rounded">
                                <h3 class="text-primary">{{ estadisticas.total_docentes }}</h3>
                                <p class="mb-0 text-muted">Docentes</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 border rounded">
                                <h3 class="text-success">{{ estadisticas.total_sedes }}</h3>
                                <p class="mb-0 text-muted">Sedes</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded">
                                <h3 class="text-info">
                                    {% if año_actual %}
                                        {{ año_actual.sede.colegio.nombre|truncatechars:15 }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </h3>
                                <p class="mb-0 text-muted">Colegio</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded">
                                <h3 class="text-warning">{{ estadisticas.estudiantes_activos }}</h3>
                                <p class="mb-0 text-muted">Matriculados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gender-ambiguous me-2"></i>Distribución por Género</h5>
                </div>
                <div class="card-body">
                    {% if distribucion_genero %}
                    <div class="chart-container" id="genderChartContainer">
                        <canvas id="genderChart"></canvas>
                    </div>
                    <div class="mt-3">
                        {% for gen in distribucion_genero %}
                        <div class="distribution-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-{% if gen.genero == 'Masculino' %}gender-male text-primary{% elif gen.genero == 'Femenino' %}gender-female text-pink{% else %}question-circle text-secondary{% endif %} me-2"></i>
                                    {{ gen.genero }}
                                </span>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2">{{ gen.total }}</span>
                                    <span class="text-muted">({{ gen.porcentaje|floatformat:1 }}%)</span>
                                </div>
                            </div>
                            <div class="progress progress-large mt-2">
                                <div class="progress-bar 
                                    {% if gen.genero == 'Masculino' %}bg-primary
                                    {% elif gen.genero == 'Femenino' %}bg-pink
                                    {% else %}bg-secondary{% endif %}" 
                                    style="width: {{ gen.porcentaje }}%">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-people display-4 text-muted"></i>
                        <p class="text-muted mt-2">No hay datos de distribución</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Distribución por Grado</h5>
                </div>
                <div class="card-body">
                    {% if distribucion_grado %}
                    <div class="chart-container" id="gradeChartContainer">
                        <canvas id="gradeChart"></canvas>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Grado</th>
                                    <th>Estudiantes</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grado in distribucion_grado %}
                                <tr>
                                    <td>{{ grado.grado_año_lectivo__grado__nombre }}</td>
                                    <td>{{ grado.total }}</td>
                                    <td>
                                        {% widthratio grado.total estadisticas.estudiantes_activos 100 as porcentaje %}
                                        {{ porcentaje|floatformat:1 }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-bar-chart display-4 text-muted"></i>
                        <p class="text-muted mt-2">No hay datos de grados</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Evolución anual -->
    <div class="row">
        <div class="col-12">
            <div class="card chart-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Evolución Anual de Matrículas</h5>
                </div>
                <div class="card-body">
                    {% if evolucion_anual %}
                    <div class="chart-container">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                    <div class="row mt-4">
                        {% for item in evolucion_anual %}
                        <div class="col-md-2 col-4 mb-2">
                            <div class="text-center p-2 border rounded">
                                <div class="fw-bold">{{ item.año }}</div>
                                <div class="text-primary fs-5">{{ item.estudiantes }}</div>
                                <small class="text-muted">estudiantes</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-graph-up display-4 text-muted"></i>
                        <p class="text-muted mt-2">No hay datos históricos disponibles</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen ejecutivo -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Resumen Ejecutivo</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Fortalezas</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-3"></i>
                                    <div>
                                        <strong>Tasa de aprobación del {{ estadisticas.tasa_aprobacion }}%</strong>
                                        <p class="mb-0 text-muted small">Indica buen rendimiento académico general</p>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-3"></i>
                                    <div>
                                        <strong>Asistencia del {{ estadisticas.asistencia_promedio }}%</strong>
                                        <p class="mb-0 text-muted small">Excelente compromiso de los estudiantes</p>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-3"></i>
                                    <div>
                                        <strong>{{ estadisticas.comportamientos_positivos }} reconocimientos positivos</strong>
                                        <p class="mb-0 text-muted small">Ambiente escolar favorable</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning mb-3">Áreas de Oportunidad</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill text-warning me-3"></i>
                                    <div>
                                        <strong>Promedio general {{ estadisticas.promedio_general }}</strong>
                                        <p class="mb-0 text-muted small">Oportunidad de mejora en rendimiento académico</p>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill text-warning me-3"></i>
                                    <div>
                                        <strong>{{ estadisticas.comportamientos_negativos }} incidencias negativas</strong>
                                        <p class="mb-0 text-muted small">Espacio para trabajar en convivencia escolar</p>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="bi bi-lightbulb-fill text-info me-3"></i>
                                    <div>
                                        <strong>Recomendaciones</strong>
                                        <p class="mb-0 text-muted small">Implementar programas de tutorías y seguimiento personalizado</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function() {
        {% if distribucion_genero %}
        // Gráfico de distribución por género
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        const genderChart = new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: [
                    {% for gen in distribucion_genero %}
                    '{{ gen.genero }}',
                    {% endfor %}
                ],
                datasets: [{
                    data: [
                        {% for gen in distribucion_genero %}
                        {{ gen.total }},
                        {% endfor %}
                    ],
                    backgroundColor: [
                        '#0d6efd',  // Masculino
                        '#d63384',  // Femenino
                        '#6c757d',  // No especificado
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
        {% endif %}
        
        {% if distribucion_grado %}
        // Gráfico de distribución por grado
        const gradeCtx = document.getElementById('gradeChart').getContext('2d');
        const gradeChart = new Chart(gradeCtx, {
            type: 'bar',
            data: {
                labels: [
                    {% for grado in distribucion_grado %}
                    '{{ grado.grado_año_lectivo__grado__nombre }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Estudiantes',
                    data: [
                        {% for grado in distribucion_grado %}
                        {{ grado.total }},
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(13, 110, 253, 0.7)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5
                        }
                    }
                }
            }
        });
        {% endif %}
        
        {% if evolucion_anual %}
        // Gráfico de evolución anual
        const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
        const evolutionChart = new Chart(evolutionCtx, {
            type: 'line',
            data: {
                labels: [
                    {% for item in evolucion_anual %}
                    '{{ item.año }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Estudiantes Matriculados',
                    data: [
                        {% for item in evolucion_anual %}
                        {{ item.estudiantes }},
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        {% endif %}
    });
</script>
{% endblock %}