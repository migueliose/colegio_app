{% extends 'gestioncolegio/base.html' %}

{% block title %}Desactivar Estudiante{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirmar Desactivación de Estudiante
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Advertencia Importante -->
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="fas fa-ban me-2"></i>¡ADVERTENCIA IMPORTANTE!
                        </h6>
                        <p class="mb-0">
                            Esta acción desactivará permanentemente al estudiante del sistema. 
                            Revise cuidadosamente la información antes de continuar.
                        </p>
                    </div>

                    <!-- Resumen del Estudiante -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Resumen del Estudiante</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    {% if estudiante.foto %}
                                    <img src="{{ estudiante.foto.url }}" alt="{{ estudiante.usuario.get_full_name }}" 
                                         class="rounded-circle img-fluid mb-3" 
                                         style="width: 100px; height: 100px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                         style="width: 100px; height: 100px;">
                                        <i class="fas fa-user-graduate fa-3x text-muted"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-9">
                                    <h4>{{ estudiante.usuario.get_full_name }}</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <strong>Documento:</strong> {{ estudiante.usuario.numero_documento }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Fecha Nacimiento:</strong> 
                                                {{ estudiante.usuario.fecha_nacimiento|date:"d/m/Y"|default:"No registrada" }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Edad:</strong> {{ estudiante.usuario.edad|default:"-" }} años
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <strong>Email:</strong> 
                                                {{ estudiante.usuario.email|default:"No registrado" }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Teléfono:</strong> 
                                                {{ estudiante.usuario.telefono|default:"No registrado" }}
                                            </p>
                                            <p class="mb-0">
                                                <strong>Estado Actual:</strong> 
                                                {% if estudiante.usuario.estado %}
                                                <span class="badge bg-success">Activo</span>
                                                {% else %}
                                                <span class="badge bg-danger">Inactivo</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impacto de la Desactivación -->
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Impacto de la Desactivación
                        </h6>
                        <ul class="mb-0">
                            <li>El estudiante <strong>perderá acceso inmediato al sistema</strong></li>
                            <li>No podrá ser matriculado en años lectivos futuros</li>
                            <li>No aparecerá en listados de estudiantes activos</li>
                            <li>Los datos históricos se mantendrán para consulta</li>
                            <li>Los acudientes asociados mantendrán su acceso (si tienen otros estudiantes activos)</li>
                        </ul>
                    </div>

                    <!-- Verificaciones Importantes -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-clipboard-check me-2"></i>
                                Verificaciones Requeridas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="check-matricula">
                                <label class="form-check-label" for="check-matricula">
                                    <strong>Verificar Matrícula Actual</strong>
                                    {% if estudiante.matricula_actual %}
                                    <span class="badge bg-warning ms-2">MATRICULADO</span>
                                    <small class="d-block text-muted">
                                        El estudiante tiene matrícula activa en 
                                        {{ estudiante.matricula_actual.grado_año_lectivo.grado.nombre }} - 
                                        {{ estudiante.matricula_actual.año_lectivo.anho }}
                                    </small>
                                    {% else %}
                                    <span class="badge bg-success ms-2">SIN MATRÍCULA</span>
                                    {% endif %}
                                </label>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="check-deudas">
                                <label class="form-check-label" for="check-deudas">
                                    <strong>Verificar Pendientes Académicos</strong>
                                    <small class="d-block text-muted">
                                        Confirmar que no tiene pendientes académicos o certificaciones pendientes
                                    </small>
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check-comunicacion">
                                <label class="form-check-label" for="check-comunicacion">
                                    <strong>Comunicación con Acudientes</strong>
                                    <small class="d-block text-muted">
                                        Se recomienda informar a los acudientes sobre la desactivación
                                    </small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas del Estudiante -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-primary mb-0">
                                        {% if acudientes %}
                                        {{ acudientes|length }}
                                        {% else %}
                                        0
                                        {% endif %}
                                    </h3>
                                    <small class="text-muted">Acudientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-info mb-0">
                                        {% if historial_academico %}
                                        {{ historial_academico.count }}
                                        {% else %}
                                        0
                                        {% endif %}
                                    </h3>
                                    <small class="text-muted">Registros Académicos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-success mb-0">
                                        {% if estudiante.matriculas_anteriores %}
                                        {{ estudiante.matriculas_anteriores.count }}
                                        {% else %}
                                        0
                                        {% endif %}
                                    </h3>
                                    <small class="text-muted">Años Matriculados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-warning mb-0">
                                        {% if comportamientos %}
                                        {{ comportamientos.count }}
                                        {% else %}
                                        0
                                        {% endif %}
                                    </h3>
                                    <small class="text-muted">Registros Conducta</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de Confirmación -->
                    <form method="post" id="delete-form">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="motivo" class="form-label">
                                <strong>Motivo de la Desactivación *</strong>
                            </label>
                            <textarea class="form-control" id="motivo" name="motivo" 
                                      rows="4" placeholder="Describa detalladamente el motivo de la desactivación..."
                                      required></textarea>
                            <small class="form-text text-muted">
                                Este motivo quedará registrado en el historial del estudiante
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="accion_adicional" class="form-label">
                                <strong>Acción Adicional</strong>
                            </label>
                            <select class="form-control" id="accion_adicional" name="accion_adicional">
                                <option value="">Seleccione una opción (opcional)</option>
                                <option value="transferir">Transferir a otro colegio</option>
                                <option value="graduacion">Graduación/Egreso</option>
                                <option value="retiro">Retiro voluntario</option>
                                <option value="disciplinario">Causa disciplinaria</option>
                                <option value="academico">Causa académica</option>
                                <option value="otro">Otro motivo</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmacion_final" required>
                                <label class="form-check-label" for="confirmacion_final">
                                    <strong>Confirmación Final</strong>
                                    <small class="d-block text-muted">
                                        Confirmo que he revisado toda la información y comprendo las consecuencias 
                                        de desactivar a este estudiante del sistema.
                                    </small>
                                </label>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'administrador:estudiante_detail' estudiante.pk %}" 
                               class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-danger btn-lg" id="submit-btn">
                                <i class="fas fa-user-slash me-2"></i> Confirmar Desactivación
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-muted">
                    <div class="row">
                        <div class="col">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Fecha: {% now "d/m/Y" %}
                        </div>
                        <div class="col text-center">
                            <i class="fas fa-user me-1"></i>
                            Usuario: {{ request.user.get_full_name }}
                        </div>
                        <div class="col text-end">
                            <i class="fas fa-id-card me-1"></i>
                            ID: {{ estudiante.pk }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Adicional -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        Preguntas Frecuentes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    ¿Puedo reactivar al estudiante posteriormente?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <strong>Sí, pero con limitaciones.</strong> Un administrador puede reactivar al estudiante, 
                                    pero tendrá que ser matriculado nuevamente en el año lectivo correspondiente.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    ¿Qué pasa con los datos académicos históricos?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Todos los datos históricos (notas, asistencias, comportamientos) se mantendrán 
                                    en el sistema para consulta y reportes históricos.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    ¿Los acudientes pierden acceso al sistema?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Solo si este era el único estudiante activo asociado al acudiente. 
                                    Si el acudiente tiene otros estudiantes activos, mantendrá su acceso.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Validación del formulario
    $('#delete-form').on('submit', function(e) {
        // Verificar checkboxes requeridos
        if (!$('#check-matricula').is(':checked')) {
            e.preventDefault();
            alert('Debe verificar la situación de matrícula del estudiante');
            $('#check-matricula').focus();
            return false;
        }

        if (!$('#confirmacion_final').is(':checked')) {
            e.preventDefault();
            alert('Debe confirmar la acción final');
            $('#confirmacion_final').focus();
            return false;
        }

        var motivo = $('#motivo').val().trim();
        if (!motivo) {
            e.preventDefault();
            alert('Debe especificar el motivo de la desactivación');
            $('#motivo').focus();
            return false;
        }

        // Confirmación final
        if (!confirm('¿CONFIRMA DEFINITIVAMENTE LA DESACTIVACIÓN DEL ESTUDIANTE?\n\nEsta acción no se puede deshacer automáticamente.')) {
            e.preventDefault();
            return false;
        }

        // Mostrar loading
        $('#submit-btn').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...');
        $('#submit-btn').prop('disabled', true);
    });

    // Habilitar/deshabilitar checkboxes de verificación
    $('#check-matricula').change(function() {
        if ($(this).is(':checked')) {
            $(this).next('label').find('.badge').removeClass('bg-warning').addClass('bg-success');
        } else {
            $(this).next('label').find('.badge').removeClass('bg-success').addClass('bg-warning');
        }
    });

    // Validación en tiempo real
    $('#motivo').on('input', function() {
        var motivo = $(this).val().trim();
        var minLength = 20;
        
        if (motivo.length >= minLength) {
            $(this).removeClass('is-invalid').addClass('is-valid');
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
        }
    });
});
</script>
{% endblock %}