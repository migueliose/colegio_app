{% extends 'gestioncolegio/base.html' %}

{% block title %}Detalle del Acudiente{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">Detalle del Acudiente</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'gestioncolegio:dashboard_administrador' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'administrador:acudiente_list' %}">Acudientes</a></li>
                    <li class="breadcrumb-item active">{{ acudiente.acudiente.get_full_name }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="{% url 'administrador:acudiente_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a href="{% url 'administrador:acudiente_update' acudiente.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <a href="{% url 'administrador:acudiente_delete' acudiente.pk %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Eliminar
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Acudiente -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-tie me-2"></i>Información del Acudiente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        {% if acudiente.acudiente.foto %}
                        <img src="{{ acudiente.acudiente.foto.url }}" alt="{{ acudiente.acudiente.get_full_name }}" 
                             class="rounded-circle img-fluid border" 
                             style="width: 120px; height: 120px; object-fit: cover;">
                        {% else %}
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center border" 
                             style="width: 120px; height: 120px;">
                            <i class="fas fa-user-tie fa-3x text-muted"></i>
                        </div>
                        {% endif %}
                        <h4 class="mt-3 mb-1">{{ acudiente.acudiente.get_full_name }}</h4>
                        <p class="text-muted">Acudiente</p>
                        <span class="badge bg-info">{{ acudiente.parentesco }}</span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Documento:</strong><br>
                                {{ acudiente.acudiente.numero_documento }}
                            </p>
                            <p><strong>Tipo Documento:</strong><br>
                                {{ acudiente.acudiente.tipo_documento.nombre|default:"No especificado" }}
                            </p>
                            <p><strong>Fecha Nacimiento:</strong><br>
                                {{ acudiente.acudiente.fecha_nacimiento|date:"d/m/Y"|default:"No registrada" }}
                            </p>
                            {% if acudiente.acudiente.edad %}
                            <p><strong>Edad:</strong><br>
                                {{ acudiente.acudiente.edad }} años
                            </p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email:</strong><br>
                                {% if acudiente.acudiente.email %}
                                <a href="mailto:{{ acudiente.acudiente.email }}" class="text-decoration-none">
                                    {{ acudiente.acudiente.email }}
                                </a>
                                {% else %}
                                <span class="text-muted">No registrado</span>
                                {% endif %}
                            </p>
                            <p><strong>Teléfono:</strong><br>
                                {% if acudiente.acudiente.telefono %}
                                <a href="tel:{{ acudiente.acudiente.telefono }}" class="text-decoration-none">
                                    {{ acudiente.acudiente.telefono }}
                                </a>
                                {% else %}
                                <span class="text-muted">No registrado</span>
                                {% endif %}
                            </p>
                            <p><strong>Dirección:</strong><br>
                                {{ acudiente.acudiente.direccion|default:"No registrada" }}
                            </p>
                            <p><strong>Estado:</strong><br>
                                {% if acudiente.acudiente.estado %}
                                <span class="badge bg-success">Activo</span>
                                {% else %}
                                <span class="badge bg-danger">Inactivo</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>Información del Usuario
                        </h6>
                        <p class="mb-0">
                            <strong>Tipo de Usuario:</strong> {{ acudiente.acudiente.tipo_usuario.nombre }}<br>
                            <strong>Usuario:</strong> {{ acudiente.acudiente.username }}<br>
                            <strong>Último Acceso:</strong> 
                            {% if acudiente.acudiente.last_login %}
                            {{ acudiente.acudiente.last_login|date:"d/m/Y H:i" }}
                            {% else %}
                            <span class="text-muted">Nunca ha accedido</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Otros Estudiantes a Cargo -->
            {% if otros_estudiantes %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Otros Estudiantes a Cargo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for otro in otros_estudiantes %}
                        <a href="{% url 'administrador:estudiante_detail' otro.estudiante.pk %}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ otro.estudiante.usuario.get_full_name }}</h6>
                                    <small class="text-muted">
                                        Parentesco: <span class="badge bg-info">{{ otro.parentesco }}</span>
                                    </small>
                                </div>
                                <div>
                                    {% if otro.estudiante.matricula_actual %}
                                    <span class="badge bg-success">
                                        {{ otro.estudiante.matricula_actual.grado_año_lectivo.grado.nombre }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning">Sin matrícula</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Información del Estudiante y Sistema -->
        <div class="col-lg-6">
            <!-- Información del Estudiante -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-graduate me-2"></i>Información del Estudiante
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        {% if acudiente.estudiante.foto %}
                        <img src="{{ acudiente.estudiante.foto.url }}" alt="{{ acudiente.estudiante.usuario.get_full_name }}" 
                             class="rounded-circle img-fluid border" 
                             style="width: 100px; height: 100px; object-fit: cover;">
                        {% else %}
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center border" 
                             style="width: 100px; height: 100px;">
                            <i class="fas fa-user-graduate fa-2x text-muted"></i>
                        </div>
                        {% endif %}
                        <h4 class="mt-3 mb-1">{{ acudiente.estudiante.usuario.get_full_name }}</h4>
                        <p class="text-muted">Estudiante</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Documento:</strong><br>
                                {{ acudiente.estudiante.usuario.numero_documento }}
                            </p>
                            <p><strong>Fecha Nacimiento:</strong><br>
                                {{ acudiente.estudiante.usuario.fecha_nacimiento|date:"d/m/Y"|default:"No registrada" }}
                            </p>
                            {% if acudiente.estudiante.usuario.edad %}
                            <p><strong>Edad:</strong><br>
                                {{ acudiente.estudiante.usuario.edad }} años
                            </p>
                            {% endif %}
                            <p><strong>Estado:</strong><br>
                                {% if acudiente.estudiante.estado %}
                                <span class="badge bg-success">Activo</span>
                                {% else %}
                                <span class="badge bg-danger">Inactivo</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Matrícula Actual:</strong><br>
                                {% if acudiente.estudiante.matricula_actual %}
                                <span class="badge bg-primary">
                                    {{ acudiente.estudiante.matricula_actual.grado_año_lectivo.grado.nombre }}
                                </span><br>
                                <small class="text-muted">
                                    {{ acudiente.estudiante.matricula_actual.sede.nombre }}
                                </small>
                                {% else %}
                                <span class="badge bg-warning">Sin matrícula activa</span>
                                {% endif %}
                            </p>
                            <p><strong>Contacto:</strong><br>
                                {% if acudiente.estudiante.usuario.email %}
                                {{ acudiente.estudiante.usuario.email }}<br>
                                {% endif %}
                                {% if acudiente.estudiante.usuario.telefono %}
                                {{ acudiente.estudiante.usuario.telefono }}
                                {% endif %}
                            </p>
                            <p><strong>Total Acudientes:</strong><br>
                                <span class="badge bg-info">
                                    {{ acudiente.estudiante.acudientes.count }}
                                </span>
                            </p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <a href="{% url 'administrador:estudiante_detail' acudiente.estudiante.pk %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i> Ver Detalle del Estudiante
                        </a>
                        <a href="{% url 'administrador:estudiante_update' acudiente.estudiante.pk %}" 
                           class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-edit me-1"></i> Editar Estudiante
                        </a>
                    </div>
                </div>
            </div>

            <!-- Información de la Relación -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-link me-2"></i>Información de la Relación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Parentesco:</strong><br>
                                <span class="badge bg-info fs-6">{{ acudiente.parentesco }}</span>
                            </p>
                            <p><strong>Fecha de Creación:</strong><br>
                                {{ acudiente.created_at|date:"d/m/Y H:i" }}
                            </p>
                            <p><strong>Última Actualización:</strong><br>
                                {{ acudiente.updated_at|date:"d/m/Y H:i" }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Creado por:</strong><br>
                                {% if acudiente.created_by %}
                                {{ acudiente.created_by.get_full_name }}
                                {% else %}
                                <span class="text-muted">Sistema</span>
                                {% endif %}
                            </p>
                            <p><strong>Estado de la Relación:</strong><br>
                                {% if acudiente.estudiante.estado and acudiente.acudiente.estado %}
                                <span class="badge bg-success">Activa</span>
                                {% else %}
                                <span class="badge bg-danger">Inactiva</span>
                                {% endif %}
                            </p>
                            <p><strong>Última Modificación:</strong><br>
                                {% if acudiente.updated_by %}
                                Por {{ acudiente.updated_by.get_full_name }}
                                {% else %}
                                <span class="text-muted">No registrada</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>Importante
                        </h6>
                        <p class="mb-0 small">
                            Esta relación se desactivará automáticamente si el estudiante o el acudiente 
                            son desactivados del sistema. Ambos usuarios deben estar activos para que 
                            la relación funcione correctamente.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <a href="{% url 'administrador:acudiente_update' acudiente.pk %}" 
                               class="btn btn-warning w-100 mb-2">
                                <i class="fas fa-edit me-1"></i> Editar Relación
                            </a>
                            <a href="#" class="btn btn-info w-100 mb-2">
                                <i class="fas fa-envelope me-1"></i> Enviar Correo
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{% url 'administrador:acudiente_delete' acudiente.pk %}" 
                               class="btn btn-danger w-100 mb-2">
                                <i class="fas fa-trash me-1"></i> Eliminar Relación
                            </a>
                            <a href="#" class="btn btn-secondary w-100 mb-2">
                                <i class="fas fa-print me-1"></i> Imprimir
                            </a>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-qrcode me-1"></i>
                            ID de Relación: <code>{{ acudiente.pk }}</code>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Interacciones -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Historial de la Relación
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#historialCollapse">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="collapse show" id="historialCollapse">
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Relación Creada</h6>
                                    <p class="mb-1 text-muted">{{ acudiente.created_at|date:"d/m/Y H:i" }}</p>
                                    <p class="mb-0">Se estableció la relación de {{ acudiente.parentesco }} 
                                    entre {{ acudiente.acudiente.get_full_name }} y 
                                    {{ acudiente.estudiante.usuario.get_full_name }}</p>
                                </div>
                            </div>
                            
                            {% if acudiente.updated_at != acudiente.created_at %}
                            <div class="timeline-item">
                                <div class="timeline-marker bg-warning"></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Última Actualización</h6>
                                    <p class="mb-1 text-muted">{{ acudiente.updated_at|date:"d/m/Y H:i" }}</p>
                                    <p class="mb-0">La relación fue actualizada por última vez</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info"></div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Estado Actual</h6>
                                    <p class="mb-1 text-muted">{% now "d/m/Y H:i" %}</p>
                                    <p class="mb-0">
                                        <strong>Relación:</strong> 
                                        {% if acudiente.estudiante.estado and acudiente.acudiente.estado %}
                                        <span class="badge bg-success">Activa</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactiva</span>
                                        {% endif %}
                                        <br>
                                        <strong>Estudiante:</strong> 
                                        {% if acudiente.estudiante.estado %}
                                        <span class="badge bg-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                        {% endif %}
                                        <br>
                                        <strong>Acudiente:</strong> 
                                        {% if acudiente.acudiente.estado %}
                                        <span class="badge bg-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -34px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.timeline-content {
    padding-left: 15px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}