{% extends 'gestioncolegio/base.html' %}

{% block title %}Eliminar Relación de Acudiente{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirmar Eliminación de Relación
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Resumen de la Relación -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 text-center border-end">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-user-tie me-2"></i>Acudiente
                                    </h5>
                                    {% if acudiente.acudiente.foto %}
                                    <img src="{{ acudiente.acudiente.foto.url }}" 
                                         alt="{{ acudiente.acudiente.get_full_name }}" 
                                         class="rounded-circle img-fluid mb-3" 
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                         style="width: 80px; height: 80px;">
                                        <i class="fas fa-user-tie fa-2x text-muted"></i>
                                    </div>
                                    {% endif %}
                                    <h6>{{ acudiente.acudiente.get_full_name }}</h6>
                                    <p class="mb-1">
                                        <small>{{ acudiente.acudiente.numero_documento }}</small>
                                    </p>
                                    <p class="mb-0">
                                        <span class="badge bg-info">{{ acudiente.parentesco }}</span>
                                    </p>
                                </div>
                                <div class="col-md-6 text-center">
                                    <h5 class="text-success mb-3">
                                        <i class="fas fa-user-graduate me-2"></i>Estudiante
                                    </h5>
                                    {% if acudiente.estudiante.foto %}
                                    <img src="{{ acudiente.estudiante.foto.url }}" 
                                         alt="{{ acudiente.estudiante.usuario.get_full_name }}" 
                                         class="rounded-circle img-fluid mb-3" 
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                         style="width: 80px; height: 80px;">
                                        <i class="fas fa-user-graduate fa-2x text-muted"></i>
                                    </div>
                                    {% endif %}
                                    <h6>{{ acudiente.estudiante.usuario.get_full_name }}</h6>
                                    <p class="mb-1">
                                        <small>{{ acudiente.estudiante.usuario.numero_documento }}</small>
                                    </p>
                                    <p class="mb-0">
                                        {% if acudiente.estudiante.matricula_actual %}
                                        <span class="badge bg-primary">
                                            {{ acudiente.estudiante.matricula_actual.grado_año_lectivo.grado.nombre }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning">Sin matrícula</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <div class="text-center mt-4">
                                <i class="fas fa-link fa-2x text-muted"></i>
                                <p class="mb-0 text-muted">
                                    Relación establecida el {{ acudiente.created_at|date:"d/m/Y" }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Advertencias -->
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="fas fa-ban me-2"></i>¡ADVERTENCIA!
                        </h6>
                        <p class="mb-0">
                            Está a punto de eliminar permanentemente esta relación de acudiente. 
                            Esta acción <strong>no se puede deshacer</strong>.
                        </p>
                    </div>

                    <!-- Verificaciones -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-clipboard-check me-2"></i>
                                Verificaciones Requeridas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="check-otros-acudientes">
                                <label class="form-check-label" for="check-otros-acudientes">
                                    <strong>Verificar otros acudientes del estudiante</strong>
                                    <small class="d-block text-muted">
                                        El estudiante tiene 
                                        <span class="badge bg-info">{{ acudiente.estudiante.acudientes.count }}</span> 
                                        acudiente(s) registrado(s).
                                        {% if acudiente.estudiante.acudientes.count <= 1 %}
                                        <span class="badge bg-danger ms-2">QUEDARÁ SIN ACUDIENTES</span>
                                        {% endif %}
                                    </small>
                                </label>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="check-notificacion">
                                <label class="form-check-label" for="check-notificacion">
                                    <strong>Notificar al acudiente (opcional)</strong>
                                    <small class="d-block text-muted">
                                        Se recomienda notificar al acudiente sobre la eliminación de la relación
                                    </small>
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check-historial">
                                <label class="form-check-label" for="check-historial">
                                    <strong>Conservar en historial</strong>
                                    <small class="d-block text-muted">
                                        La relación se eliminará pero quedará registro en el historial del sistema
                                    </small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-primary mb-0">
                                        {{ acudiente.estudiante.acudientes.count }}
                                    </h3>
                                    <small class="text-muted">Acudientes del estudiante</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-info mb-0">
                                        {% if otros_estudiantes %}
                                        {{ otros_estudiantes|length }}
                                        {% else %}
                                        0
                                        {% endif %}
                                    </h3>
                                    <small class="text-muted">Otros estudiantes del acudiente</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-success mb-0">
                                        {{ acudiente.acudiente.acudiente_profile.count|default:"0" }}
                                    </h3>
                                    <small class="text-muted">Relaciones del acudiente</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de Confirmación -->
                    <form method="post" id="delete-form">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="motivo" class="form-label">
                                <strong>Motivo de la Eliminación *</strong>
                            </label>
                            <textarea class="form-control" id="motivo" name="motivo" 
                                      rows="3" placeholder="Describa el motivo de la eliminación..."
                                      required></textarea>
                            <small class="form-text text-muted">
                                Este motivo quedará registrado en el historial del sistema
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="tipo_eliminacion" class="form-label">
                                <strong>Tipo de Eliminación</strong>
                            </label>
                            <select class="form-control" id="tipo_eliminacion" name="tipo_eliminacion">
                                <option value="">Seleccione una opción (opcional)</option>
                                <option value="error">Error en el registro</option>
                                <option value="cambio">Cambio de acudiente</option>
                                <option value="solicitud">Solicitud del acudiente</option>
                                <option value="solicitud_estudiante">Solicitud del estudiante</option>
                                <option value="finalizacion">Finalización de relación</option>
                                <option value="otro">Otro motivo</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmacion_final" required>
                                <label class="form-check-label" for="confirmacion_final">
                                    <strong>Confirmación Final</strong>
                                    <small class="d-block text-muted">
                                        Confirmo que he revisado toda la información y comprendo que esta acción 
                                        eliminará permanentemente la relación de acudiente.
                                    </small>
                                </label>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'administrador:acudiente_detail' acudiente.pk %}" 
                               class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-danger btn-lg" id="submit-btn">
                                <i class="fas fa-trash me-2"></i> Confirmar Eliminación
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-muted">
                    <div class="row">
                        <div class="col">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Fecha: {% now "d/m/Y" %}
                        </div>
                        <div class="col text-center">
                            <i class="fas fa-user me-1"></i>
                            Usuario: {{ request.user.get_full_name }}
                        </div>
                        <div class="col text-end">
                            <i class="fas fa-id-card me-1"></i>
                            ID Relación: {{ acudiente.pk }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Adicional -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        Preguntas Frecuentes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    ¿Qué pasa si el estudiante queda sin acudientes?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <strong>El estudiante quedará sin acudientes registrados.</strong> 
                                    Esto puede afectar la comunicación del colegio con la familia. 
                                    Se recomienda registrar al menos un acudiente por estudiante.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    ¿El acudiente pierde acceso al sistema?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Solo si esta era la única relación activa del acudiente. 
                                    Si el acudiente tiene otros estudiantes a cargo, mantendrá su acceso al sistema.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    ¿Se puede recuperar la relación eliminada?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <strong>No automáticamente.</strong> Para restaurar la relación, debe crear 
                                    una nueva relación entre el estudiante y el acudiente. Los datos históricos 
                                    anteriores a la eliminación se mantendrán para consulta.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Validación del formulario
    $('#delete-form').on('submit', function(e) {
        // Verificar checkboxes requeridos
        if (!$('#check-otros-acudientes').is(':checked')) {
            e.preventDefault();
            alert('Debe verificar los otros acudientes del estudiante');
            $('#check-otros-acudientes').focus();
            return false;
        }

        if (!$('#confirmacion_final').is(':checked')) {
            e.preventDefault();
            alert('Debe confirmar la acción final');
            $('#confirmacion_final').focus();
            return false;
        }

        var motivo = $('#motivo').val().trim();
        if (!motivo) {
            e.preventDefault();
            alert('Debe especificar el motivo de la eliminación');
            $('#motivo').focus();
            return false;
        }

        // Verificar si el estudiante quedará sin acudientes
        var otrosAcudientes = {{ acudiente.estudiante.acudientes.count }};
        if (otrosAcudientes <= 1) {
            if (!confirm('¡ATENCIÓN!\n\nEste estudiante quedará SIN ACUDIENTES registrados.\n\n¿Está seguro de continuar?')) {
                e.preventDefault();
                return false;
            }
        }

        // Confirmación final
        if (!confirm('¿CONFIRMA DEFINITIVAMENTE LA ELIMINACIÓN DE ESTA RELACIÓN?\n\nEsta acción NO se puede deshacer.')) {
            e.preventDefault();
            return false;
        }

        // Mostrar loading
        $('#submit-btn').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Eliminando...');
        $('#submit-btn').prop('disabled', true);
    });

    // Habilitar/deshabilitar checkboxes de verificación
    $('#check-otros-acudientes').change(function() {
        if ($(this).is(':checked')) {
            var count = {{ acudiente.estudiante.acudientes.count }};
            if (count <= 1) {
                $(this).next('label').find('.badge').removeClass('bg-info').addClass('bg-danger');
            } else {
                $(this).next('label').find('.badge').removeClass('bg-danger').addClass('bg-success');
            }
        } else {
            $(this).next('label').find('.badge').removeClass('bg-success bg-danger').addClass('bg-info');
        }
    });

    // Validación en tiempo real
    $('#motivo').on('input', function() {
        var motivo = $(this).val().trim();
        var minLength = 10;
        
        if (motivo.length >= minLength) {
            $(this).removeClass('is-invalid').addClass('is-valid');
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
        }
    });
});
</script>
{% endblock %}