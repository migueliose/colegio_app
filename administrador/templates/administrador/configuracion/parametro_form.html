<!-- administrador/configuracion/parametro_form.html -->
{% extends 'gestioncolegio/base2.html' %}
{% load static %}

{% block title %}{{ title }} - Configuración{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        color: white;
    }
    .type-preview {
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.9rem;
        display: none;
    }
    .preview-texto { 
        background-color: #e3f2fd; 
        border-left: 4px solid #4e73df; 
        color: #0d47a1;
    }
    .preview-numero { 
        background-color: #e8f5e9; 
        border-left: 4px solid #1cc88a; 
        color: #1b5e20;
    }
    .preview-booleano { 
        background-color: #fff3e0; 
        border-left: 4px solid #f6c23e; 
        color: #e65100;
    }
    .preview-fecha { 
        background-color: #ffebee; 
        border-left: 4px solid #e74a3b; 
        color: #b71c1c;
    }
    .type-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    .badge-texto { background-color: #4e73df; color: white; }
    .badge-numero { background-color: #1cc88a; color: white; }
    .badge-booleano { background-color: #f6c23e; color: #212529; }
    .badge-fecha { background-color: #e74a3b; color: white; }
    .value-example {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        padding: 5px 10px;
        border-radius: 3px;
        border: 1px solid #dee2e6;
        font-size: 0.9rem;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-white">
                            <i class="fas fa-sliders-h me-2"></i>{{ title }}
                        </h4>
                        <a href="{% url 'administrador:parametro_list' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i> Volver
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Clave del Parámetro -->
                        <div class="mb-4">
                            <label for="{{ form.clave.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-key me-1"></i>Clave del Parámetro <span class="text-danger">*</span>
                            </label>
                            {{ form.clave }}
                            {% if form.clave.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.clave.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text text-muted">
                                Use minúsculas y guiones bajos. Ej: max_intentos_login, tiempo_sesion_minutos, habilitar_notificaciones
                            </div>
                        </div>
                        
                        <!-- Tipo de Dato -->
                        <div class="mb-4">
                            <label for="{{ form.tipo.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-database me-1"></i>Tipo de Dato <span class="text-danger">*</span>
                            </label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.tipo.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Ejemplos de tipos -->
                            <div class="mt-3">
                                <p class="mb-2 small fw-semibold">Ejemplos por tipo:</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="type-badge badge-texto">
                                        <i class="fas fa-font me-1"></i>Texto
                                    </span>
                                    <span class="type-badge badge-numero">
                                        <i class="fas fa-hashtag me-1"></i>Número
                                    </span>
                                    <span class="type-badge badge-booleano">
                                        <i class="fas fa-toggle-on me-1"></i>Booleano
                                    </span>
                                    <span class="type-badge badge-fecha">
                                        <i class="fas fa-calendar me-1"></i>Fecha
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Valor del Parámetro -->
                        <div class="mb-4">
                            <label for="{{ form.valor.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-tag me-1"></i>Valor <span class="text-danger">*</span>
                            </label>
                            {{ form.valor }}
                            {% if form.valor.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.valor.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Previsualización según tipo -->
                            <div id="preview-texto" class="type-preview preview-texto">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong class="me-2">Valores de ejemplo para Texto:</strong>
                                </div>
                                <div class="value-example">"Nombre del colegio"</div>
                                <div class="value-example">"Dirección principal, Ciudad"</div>
                                <div class="value-example">"Resolución 1234 de 2023"</div>
                            </div>
                            
                            <div id="preview-numero" class="type-preview preview-numero">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong class="me-2">Valores de ejemplo para Número:</strong>
                                </div>
                                <div class="value-example">100 (entero)</div>
                                <div class="value-example">60.5 (decimal)</div>
                                <div class="value-example">-10 (negativo)</div>
                                <div class="value-example">0 (cero)</div>
                            </div>
                            
                            <div id="preview-booleano" class="type-preview preview-booleano">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong class="me-2">Valores de ejemplo para Booleano:</strong>
                                </div>
                                <div class="value-example">true / false</div>
                                <div class="value-example">1 / 0</div>
                                <div class="value-example">yes / no</div>
                                <div class="value-example">on / off</div>
                            </div>
                            
                            <div id="preview-fecha" class="type-preview preview-fecha">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong class="me-2">Valores de ejemplo para Fecha:</strong>
                                </div>
                                <div class="value-example">2024-01-15 (YYYY-MM-DD)</div>
                                <div class="value-example">15/01/2024 (DD/MM/YYYY)</div>
                                <div class="value-example">2024-01-15 14:30:00 (con hora)</div>
                            </div>
                        </div>
                        
                        <!-- Descripción -->
                        <div class="mb-4">
                            <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-align-left me-1"></i>Descripción <span class="text-danger">*</span>
                            </label>
                            {{ form.descripcion }}
                            {% if form.descripcion.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.descripcion.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text text-muted">
                                Describa el propósito, uso y contexto de este parámetro en el sistema.
                            </div>
                        </div>
                        
                        <!-- Ejemplos de parámetros comunes -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info bg-opacity-10 border-info">
                                <h6 class="mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>Ejemplos de Parámetros Comunes
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-check text-success mt-1 me-2"></i>
                                            <div>
                                                <small class="fw-semibold">max_estudiantes_grupo</small>
                                                <div class="small text-muted">Número máximo de estudiantes por grupo (40)</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-check text-success mt-1 me-2"></i>
                                            <div>
                                                <small class="fw-semibold">habilitar_matriculas</small>
                                                <div class="small text-muted">Controla si se permiten matrículas (true/false)</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-check text-success mt-1 me-2"></i>
                                            <div>
                                                <small class="fw-semibold">dias_vencimiento_pago</small>
                                                <div class="small text-muted">Días para vencer un pago (30)</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-check text-success mt-1 me-2"></i>
                                            <div>
                                                <small class="fw-semibold">notificaciones_correo</small>
                                                <div class="small text-muted">Habilitar envío de correos (yes/no)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'administrador:parametro_list' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> {{ submit_text }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block inline_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Añadir clases Bootstrap a los campos
        const textInputs = document.querySelectorAll('input[type="text"]');
        const textareas = document.querySelectorAll('textarea');
        const selects = document.querySelectorAll('select');
        
        textInputs.forEach(input => input.classList.add('form-control'));
        textareas.forEach(textarea => {
            textarea.classList.add('form-control');
            textarea.rows = 4;
        });
        selects.forEach(select => select.classList.add('form-control'));
        
        // Elementos del DOM
        const tipoSelect = document.getElementById('{{ form.tipo.id_for_label }}');
        const claveInput = document.getElementById('{{ form.clave.id_for_label }}');
        const valorTextarea = document.getElementById('{{ form.valor.id_for_label }}');
        
        // Mostrar previsualización según tipo seleccionado
        function updatePreview() {
            // Ocultar todas las previsualizaciones
            document.querySelectorAll('.type-preview').forEach(preview => {
                preview.style.display = 'none';
            });
            
            // Mostrar la previsualización correspondiente al tipo seleccionado
            if (tipoSelect && tipoSelect.value) {
                const previewId = 'preview-' + tipoSelect.value;
                const previewElement = document.getElementById(previewId);
                if (previewElement) {
                    previewElement.style.display = 'block';
                }
                
                // Ajustar placeholder del valor según el tipo
                if (valorTextarea) {
                    switch(tipoSelect.value) {
                        case 'texto':
                            valorTextarea.placeholder = 'Ingrese texto (ej: "Valor de ejemplo")';
                            break;
                        case 'numero':
                            valorTextarea.placeholder = 'Ingrese número (ej: 100, 3.14, -5)';
                            break;
                        case 'booleano':
                            valorTextarea.placeholder = 'true/false, 1/0, yes/no, on/off';
                            break;
                        case 'fecha':
                            valorTextarea.placeholder = 'YYYY-MM-DD, DD/MM/YYYY, o YYYY-MM-DD HH:MM:SS';
                            break;
                    }
                }
            }
        }
        
        // Inicializar previsualización
        if (tipoSelect) {
            tipoSelect.addEventListener('change', updatePreview);
            updatePreview(); // Ejecutar al cargar la página
        }
        
        // Formatear clave automáticamente (al salir del campo)
        if (claveInput) {
            claveInput.addEventListener('blur', function() {
                let value = this.value.trim();
                
                if (value) {
                    // Convertir a minúsculas
                    value = value.toLowerCase();
                    
                    // Reemplazar espacios, guiones y caracteres especiales por guiones bajos
                    value = value.replace(/[^a-z0-9_]/g, '_');
                    
                    // Eliminar múltiples guiones bajos consecutivos
                    value = value.replace(/_+/g, '_');
                    
                    // Eliminar guiones bajos al inicio y final
                    value = value.replace(/^_+|_+$/g, '');
                    
                    this.value = value;
                }
            });
            
            // También formatear mientras se escribe (opcional)
            claveInput.addEventListener('input', function() {
                let cursorPos = this.selectionStart;
                let value = this.value;
                
                // Solo permitir letras, números y guiones bajos
                let newValue = value.replace(/[^a-zA-Z0-9_]/g, '_');
                
                // Si cambió el valor, actualizar
                if (value !== newValue) {
                    this.value = newValue;
                    // Restaurar posición del cursor
                    this.setSelectionRange(cursorPos - 1, cursorPos - 1);
                }
            });
        }
        
        // Validación en tiempo real para valores según tipo
        if (valorTextarea && tipoSelect) {
            valorTextarea.addEventListener('input', function() {
                const tipo = tipoSelect.value;
                const valor = this.value.trim();
                
                // Solo validar si hay valor y tipo seleccionado
                if (valor && tipo) {
                    let esValido = true;
                    let mensajeError = '';
                    
                    switch(tipo) {
                        case 'numero':
                            // Validar que sea un número válido
                            if (isNaN(valor) && valor !== '') {
                                esValido = false;
                                mensajeError = 'Debe ser un número válido';
                            }
                            break;
                        case 'booleano':
                            // Validar valores booleanos comunes
                            const valoresBooleanos = ['true', 'false', '1', '0', 'yes', 'no', 'on', 'off'];
                            if (!valoresBooleanos.includes(valor.toLowerCase())) {
                                esValido = false;
                                mensajeError = 'Use: true/false, 1/0, yes/no, on/off';
                            }
                            break;
                        case 'fecha':
                            // Validación simple de fecha (puede mejorarse)
                            const regexFecha1 = /^\d{4}-\d{2}-\d{2}$/;
                            const regexFecha2 = /^\d{2}\/\d{2}\/\d{4}$/;
                            const regexFechaHora = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/;
                            
                            if (!regexFecha1.test(valor) && 
                                !regexFecha2.test(valor) && 
                                !regexFechaHora.test(valor)) {
                                esValido = false;
                                mensajeError = 'Formato: YYYY-MM-DD, DD/MM/YYYY o YYYY-MM-DD HH:MM:SS';
                            }
                            break;
                    }
                    
                    // Mostrar/ocultar mensaje de error
                    const errorDiv = this.nextElementSibling;
                    if (!esValido) {
                        if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
                            const divError = document.createElement('div');
                            divError.className = 'invalid-feedback d-block';
                            divError.textContent = mensajeError;
                            this.parentNode.insertBefore(divError, this.nextSibling);
                        } else {
                            errorDiv.textContent = mensajeError;
                            errorDiv.style.display = 'block';
                        }
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                        if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                            errorDiv.style.display = 'none';
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}