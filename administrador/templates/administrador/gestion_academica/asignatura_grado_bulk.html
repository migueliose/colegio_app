{% extends 'gestioncolegio/base.html' %}
{% load static %}

{% block title %}Asignación Masiva de Asignaturas{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4">
            <i class="fas fa-layer-group me-2"></i>Asignación Masiva de Asignaturas
        </h1>
        <div>
            <a href="{% url 'administrador:asignatura_grado_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-cogs me-2"></i>Configurar Asignación Masiva
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="bulkForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <p class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="row g-3">
                            <!-- Año Lectivo -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.año_lectivo.id_for_label }}" class="form-label">
                                        Año Lectivo *
                                    </label>
                                    {{ form.año_lectivo }}
                                    {% if form.año_lectivo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.año_lectivo.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Todas las asignaturas se asignarán a este año lectivo
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Grados -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.grados.id_for_label }}" class="form-label">
                                        Grados *
                                    </label>
                                    {{ form.grados }}
                                    {% if form.grados.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.grados.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Ctrl+clic para seleccionar múltiples grados
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Asignaturas -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.asignaturas.id_for_label }}" class="form-label">
                                        Asignaturas *
                                    </label>
                                    {{ form.asignaturas }}
                                    {% if form.asignaturas.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.asignaturas.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Ctrl+clic para seleccionar múltiples asignaturas
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Sedes -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.sedes.id_for_label }}" class="form-label">
                                        Sedes *
                                    </label>
                                    {{ form.sedes }}
                                    {% if form.sedes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.sedes.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Las asignaturas se asignarán a todas las sedes seleccionadas
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Opciones -->
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-sliders-h me-2"></i>Opciones de Asignación
                                        </h6>
                                        
                                        <div class="form-check mb-3">
                                            {{ form.asignar_docente_automaticamente }}
                                            <label class="form-check-label" for="{{ form.asignar_docente_automaticamente.id_for_label }}">
                                                {{ form.asignar_docente_automaticamente.label }}
                                            </label>
                                            <small class="form-text text-muted d-block">
                                                Si hay docentes disponibles, se asignarán automáticamente a las asignaturas
                                            </small>
                                        </div>
                                        
                                        <div class="form-check">
                                            {{ form.sobrescribir_existentes }}
                                            <label class="form-check-label" for="{{ form.sobrescribir_existentes.id_for_label }}">
                                                {{ form.sobrescribir_existentes.label }}
                                            </label>
                                            <small class="form-text text-muted d-block">
                                                Si está marcado, eliminará asignaturas existentes y creará nuevas
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resumen de la asignación -->
                            <div class="col-12 mt-3">
                                <div class="card bg-info text-white">
                                    <div class="card-header">
                                        <i class="fas fa-calculator me-2"></i>Resumen de la Asignación
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-4">
                                                <h3 id="totalGrados">0</h3>
                                                <p class="mb-0">Grados</p>
                                            </div>
                                            <div class="col-md-4">
                                                <h3 id="totalAsignaturas">0</h3>
                                                <p class="mb-0">Asignaturas</p>
                                            </div>
                                            <div class="col-md-4">
                                                <h3 id="totalSedes">0</h3>
                                                <p class="mb-0">Sedes</p>
                                            </div>
                                        </div>
                                        <hr class="bg-white">
                                        <div class="text-center">
                                            <h4 id="totalAsignaciones">0</h4>
                                            <p class="mb-0">Total de asignaciones a crear</p>
                                            <small>(Grados × Asignaturas × Sedes)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-play-circle me-1"></i>Ejecutar Asignación Masiva
                            </button>
                            <a href="{% url 'administrador:asignatura_grado_list' %}" class="btn btn-secondary">
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Guía de Uso -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-question-circle me-2"></i>Guía de Uso
                </div>
                <div class="card-body">
                    <h6>¿Qué hace esta herramienta?</h6>
                    <p class="small">
                        Crea múltiples asignaturas por grado de forma simultánea. 
                        Útil para configurar el plan de estudios al inicio del año.
                    </p>
                    
                    <hr>
                    
                    <h6>Ejemplo de uso:</h6>
                    <p class="small">
                        <strong>Para configurar Preescolar:</strong><br>
                        1. Seleccione año lectivo "2024"<br>
                        2. Grados: "Prejardín, Jardín, Transición"<br>
                        3. Asignaturas: "Español, Matemáticas, Ciencias"<br>
                        4. Sedes: "Sede Principal"<br>
                    </p>
                    <p class="small mb-0">
                        <strong>Resultado:</strong> Se crearán 9 asignaturas (3 grados × 3 asignaturas)
                    </p>
                    
                    <hr>
                    
                    <h6>Recomendaciones:</h6>
                    <ul class="small mb-0">
                        <li>Verifique que los grados existan en el año seleccionado</li>
                        <li>Revise las asignaciones existentes para evitar duplicados</li>
                        <li>Realice una asignación de prueba con pocos elementos</li>
                        <li>Haga backup antes de sobrescribir asignaciones</li>
                    </ul>
                </div>
            </div>
            
            <!-- Validaciones -->
            <div class="card">
                <div class="card-header bg-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>Validaciones Automáticas
                </div>
                <div class="card-body">
                    <div id="validaciones">
                        <p class="small text-muted">Las validaciones se mostrarán aquí al seleccionar elementos</p>
                    </div>
                    <div id="errores" class="alert alert-danger d-none">
                        <h6><i class="fas fa-times-circle me-2"></i>Errores encontrados:</h6>
                        <ul id="listaErrores" class="mb-0 small"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Calcular total de asignaciones
    function calcularAsignaciones() {
        var grados = $('#id_grados').val() ? $('#id_grados').val().length : 0;
        var asignaturas = $('#id_asignaturas').val() ? $('#id_asignaturas').val().length : 0;
        var sedes = $('#id_sedes').val() ? $('#id_sedes').val().length : 0;
        
        $('#totalGrados').text(grados);
        $('#totalAsignaturas').text(asignaturas);
        $('#totalSedes').text(sedes);
        
        var total = grados * asignaturas * sedes;
        $('#totalAsignaciones').text(total);
        
        // Validaciones
        var errores = [];
        var validaciones = [];
        
        if (grados === 0) errores.push('Debe seleccionar al menos un grado');
        if (asignaturas === 0) errores.push('Debe seleccionar al menos una asignatura');
        if (sedes === 0) errores.push('Debe seleccionar al menos una sede');
        
        if (total > 100) {
            validaciones.push(`⚠️ Se crearán ${total} asignaturas. Esta operación puede tardar.`);
        }
        if (total > 0) {
            validaciones.push(`✅ Se crearán ${total} asignaturas por grado`);
        }
        
        // Mostrar/ocultar errores
        if (errores.length > 0) {
            $('#listaErrores').empty();
            errores.forEach(function(error) {
                $('#listaErrores').append('<li>' + error + '</li>');
            });
            $('#errores').removeClass('d-none');
            $('#validaciones').addClass('d-none');
        } else {
            $('#errores').addClass('d-none');
            $('#validaciones').html('<ul class="mb-0 small">' + 
                validaciones.map(v => '<li>' + v + '</li>').join('') + 
            '</ul>');
            $('#validaciones').removeClass('d-none');
        }
        
        return total;
    }
    
    // Actualizar cálculo cuando cambian las selecciones
    $('#id_grados, #id_asignaturas, #id_sedes').change(function() {
        calcularAsignaciones();
    });
    
    // Cargar grados según año lectivo
    $('#id_año_lectivo').change(function() {
        var añoId = $(this).val();
        if (añoId) {
            // Aquí podrías hacer AJAX para cargar solo los grados de ese año
        }
        calcularAsignaciones();
    });
    
    // Inicializar cálculo
    calcularAsignaciones();
    
    // Confirmación para sobrescribir
    $('#bulkForm').submit(function(e) {
        var total = calcularAsignaciones();
        var sobrescribir = $('#id_sobrescribir_existentes').is(':checked');
        
        if (total > 50 && !sobrescribir) {
            return confirm(`⚠️ Se crearán ${total} asignaturas.\n\n¿Desea continuar?`);
        }
        
        if (sobrescribir) {
            return confirm(`⚠️ ATENCIÓN: Esta acción sobrescribirá asignaturas existentes.\n\n¿Está seguro de continuar?`);
        }
    });
});
</script>
{% endblock %}